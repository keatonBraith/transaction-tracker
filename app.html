<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction Tracker</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        background-color: #f7f9fc;
      }

      header {
        background-color: #007bff;
        color: white;
        padding: 1rem;
        text-align: center;
      }

      main {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      input,
      select,
      button {
        padding: 0.6rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 1rem;
      }

      button {
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
      }

      button.delete {
        background-color: #dc3545;
      }

      button.edit {
        background-color: #ffc107;
      }

      button.save {
        background-color: #007bff;
      }

      button.cancel {
        background-color: gray;
      }

      .transaction {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
      }

      .transaction-details {
        display: flex;
        gap: 1rem;
      }

      .transaction-actions {
        display: flex;
        gap: 0.5rem;
      }

      .inline-edit {
        padding: 0.3rem;
        font-size: 0.9rem;
        width: 100px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Transaction Tracker</h1>
    </header>
    <main>
      <div class="form-group">
        <input type="date" id="tx-date" />
        <input type="text" id="tx-location" placeholder="Location" />
        <input type="number" id="tx-amount" placeholder="Amount" min="0" />
        <button id="add-transaction">Add</button>
      </div>

      <div class="form-group">
        <label for="monthSelect">Filter by Month:</label>
        <select id="monthSelect"></select>
      </div>

      <div id="transaction-list"></div>
    </main>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js";

      const SUPABASE_URL = "https://keeumcpbteamhbnypuqa.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlZXVtY3BidGVhbWhibnlwdXFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MDU0NDYsImV4cCI6MjA2ODI4MTQ0Nn0.Ix1bgVR5D_2qgtDljJsP8N2-kpXmpZ-l-JRSJC3JG8s";

      let user = null;
      let transactions = [];

      async function init() {
        const { data, error } = await supabase.auth.getUser();
        if (error || !data.user) {
          window.location.href = "index.html";
          return;
        }

        user = data.user;
        await fetchTransactions();
        populateMonthDropdown();
        renderTransactions();
      }

      async function fetchTransactions() {
        const { data, error } = await supabase
          .from("transactions")
          .select("*")
          .eq("user_id", user.id)
          .order("date", { ascending: false });

        if (error) {
          alert("Failed to fetch transactions");
          return;
        }

        transactions = data;
      }

      function formatMonthKey(dateStr) {
        const d = new Date(dateStr);
        return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(
          2,
          "0"
        )}`;
      }

      function populateMonthDropdown() {
        const monthSelect = document.getElementById("monthSelect");
        const months = Array.from(
          new Set(transactions.map((t) => formatMonthKey(t.date)))
        )
          .sort()
          .reverse();

        monthSelect.innerHTML = months
          .map((m) => `<option value="${m}">${m}</option>`)
          .join("");
      }

      function renderTransactions() {
        const list = document.getElementById("transaction-list");
        const selectedMonth = document.getElementById("monthSelect").value;
        list.innerHTML = "";

        const filtered = transactions.filter(
          (t) => formatMonthKey(t.date) === selectedMonth
        );

        filtered.forEach((tx) => {
          const txDiv = document.createElement("div");
          txDiv.className = "transaction";

          const detailsDiv = document.createElement("div");
          detailsDiv.className = "transaction-details";
          detailsDiv.textContent = `${tx.date} — ${
            tx.location
          } — $${tx.amount.toFixed(2)}`;

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "transaction-actions";

          const editBtn = document.createElement("button");
          editBtn.className = "edit";
          editBtn.textContent = "Edit";
          editBtn.addEventListener("click", () =>
            startEditTransaction(txDiv, tx)
          );

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete";
          deleteBtn.textContent = "Delete";
          deleteBtn.addEventListener("click", () => deleteTransaction(tx.id));

          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(deleteBtn);

          txDiv.appendChild(detailsDiv);
          txDiv.appendChild(actionsDiv);
          list.appendChild(txDiv);
        });
      }

      document
        .getElementById("add-transaction")
        .addEventListener("click", async () => {
          const date = document.getElementById("tx-date").value;
          const location = document.getElementById("tx-location").value.trim();
          const amount = parseFloat(document.getElementById("tx-amount").value);

          if (!date || !location || isNaN(amount)) {
            alert("Please fill out all fields correctly.");
            return;
          }

          const { data, error } = await supabase.from("transactions").insert([
            {
              date,
              location,
              amount,
              user_id: user.id,
            },
          ]);

          if (error) {
            alert("Error adding transaction: " + error.message);
          } else {
            await fetchTransactions();
            populateMonthDropdown();
            renderTransactions();
          }
        });

      async function deleteTransaction(id) {
        const { error } = await supabase
          .from("transactions")
          .delete()
          .eq("id", id);

        if (error) {
          alert("Failed to delete: " + error.message);
          return;
        }

        transactions = transactions.filter((t) => t.id !== id);
        renderTransactions();
        populateMonthDropdown();
      }

      function startEditTransaction(txDiv, tx) {
        txDiv.innerHTML = "";

        const detailsDiv = document.createElement("div");
        detailsDiv.className = "transaction-details";

        const dateInput = document.createElement("input");
        dateInput.type = "date";
        dateInput.className = "inline-edit";
        dateInput.value = tx.date;

        const locationInput = document.createElement("input");
        locationInput.type = "text";
        locationInput.className = "inline-edit";
        locationInput.value = tx.location;

        const amountInput = document.createElement("input");
        amountInput.type = "number";
        amountInput.step = "0.01";
        amountInput.min = "0";
        amountInput.className = "inline-edit";
        amountInput.value = tx.amount;

        detailsDiv.appendChild(dateInput);
        detailsDiv.appendChild(locationInput);
        detailsDiv.appendChild(amountInput);

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "transaction-actions";

        const saveBtn = document.createElement("button");
        saveBtn.className = "save";
        saveBtn.textContent = "Save";

        const cancelBtn = document.createElement("button");
        cancelBtn.className = "cancel";
        cancelBtn.textContent = "Cancel";

        actionsDiv.appendChild(saveBtn);
        actionsDiv.appendChild(cancelBtn);

        txDiv.appendChild(detailsDiv);
        txDiv.appendChild(actionsDiv);

        cancelBtn.addEventListener("click", renderTransactions);

        saveBtn.addEventListener("click", async () => {
          if (
            !dateInput.value ||
            !locationInput.value.trim() ||
            isNaN(parseFloat(amountInput.value)) ||
            parseFloat(amountInput.value) < 0
          ) {
            alert("Please fill out all fields correctly.");
            return;
          }

          const { error } = await supabase
            .from("transactions")
            .update({
              date: dateInput.value,
              location: locationInput.value.trim(),
              amount: parseFloat(amountInput.value),
            })
            .eq("id", tx.id)
            .eq("user_id", user.id);

          if (error) {
            alert("Failed to update: " + error.message);
          } else {
            await fetchTransactions();
            populateMonthDropdown();
            renderTransactions();
          }
        });
      }

      document
        .getElementById("monthSelect")
        .addEventListener("change", renderTransactions);

      init();
    </script>
  </body>
</html>
